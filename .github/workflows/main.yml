name: ⏳ Sync upstream Releases

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # 1. 把 PAT 写入 ~/.netrc，所有后续 git clone/fetch/push 都会用它
      - name: Setup Git authentication
        run: |
          printf "machine github.com\nlogin x-access-token\npassword ${{ secrets.WORKFLOW_TOKEN }}\n" > ~/.netrc
          chmod 600 ~/.netrc

      # 2. 用 checkout 拉仓库，不指定 token，就会走 ~/.netrc
      - name: Checkout with full history
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 3. 添加 upstream 并抓标签
      - name: Add upstream remote & fetch tags
        run: |
          git remote add upstream https://github.com/homuler/MediaPipeUnityPlugin.git
          git fetch upstream --tags

      # 4. 按默认分支推标签回 origin
      - name: Push tags to origin
        run: |
          default_branch=$(git remote show origin | sed -n -e '/HEAD branch/s/.*: //p')
          git push origin --tags
